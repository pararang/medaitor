<!DOCTYPE html>
<html data-theme="dark">
<head>
    <title>Go Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-self { justify-content: flex-end; }
        .message-other { justify-content: flex-start; }
    </style>
</head>
<body class="min-h-screen p-8 bg-base-200">
    <div class="card w-96 mx-auto bg-base-100 shadow-xl" id="authSection">
        <div class="card-body">
            <div class="tabs">
                <button class="tab tab-active" onclick="showTab('login')">Login</button> 
                <button class="tab" onclick="showTab('register')">Register</button>
            </div>
            
            <div id="login" class="space-y-4">
                <input type="text" id="loginUser" placeholder="Username" class="input input-bordered w-full">
                <input type="password" id="loginPass" placeholder="Password" class="input input-bordered w-full">
                <button onclick="login()" class="btn btn-primary w-full">Login</button>
            </div>

            <div id="register" class="hidden space-y-4">
                <input type="text" id="regUser" placeholder="Username" class="input input-bordered w-full">
                <input type="password" id="regPass" placeholder="Password" class="input input-bordered w-full">
                <button onclick="register()" class="btn btn-secondary w-full">Register</button>
            </div>
        </div>
    </div>

    <div id="chatSection" class="hidden">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div id="messages" class="h-96 overflow-y-auto space-y-2 p-4">
                    <!-- Messages will be inserted here -->
                </div>
                <div class="join w-full">
                    <input type="text" id="messageInput" class="input input-bordered join-item flex-1" 
                           placeholder="Type a message" onkeypress="if(event.keyCode===13) sendMessage()">
                    <button onclick="sendMessage()" class="btn btn-primary join-item">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let token;

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.querySelectorAll('[id="login"], [id="register"]').forEach(t => t.classList.add('hidden'));
            document.getElementById(tab).classList.remove('hidden');
            event.target.classList.add('tab-active');
        }

        async function login() {
            const username = document.getElementById('loginUser').value.trim();
            const password = document.getElementById('loginPass').value.trim();
            if (!username || !password) return;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ username, password })
                });

                if (!response.ok) throw new Error('Login failed');
                
                token = await response.text();
                initializeChat();
            } catch (error) {
                alert(error.message);
            }
        }

        async function register() {
            const username = document.getElementById('regUser').value.trim();
            const password = document.getElementById('regPass').value.trim();
            if (!username || !password) return;

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ username, password })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                alert('Registration successful! Please login.');
                showTab('login');
            } catch (error) {
                alert(error.message);
            }
        }

        function initializeChat() {
            ws = new WebSocket('ws://localhost:8080/ws');
            
            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: "auth",
                    token: token
                }));
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('chatSection').classList.remove('hidden');
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                switch(msg.type) {
                    case 'auth_success':
                        loadHistory(msg.username);
                        break;
                    case 'message':
                        appendMessage(msg.username, msg.content, msg.is_self);
                        break;
                    case 'user_join':
                        if (!msg.is_self) { //Allow login on other clients, need to prevent mulitple sessions
                            appendSystemMessage(`${msg.username} joined the chat`);
                        }
                        break;
                    case 'user_leave':
                        if (!msg.is_self) {
                            appendSystemMessage(`${msg.username} left the chat`);
                        }
                        break;
                }
            };

            window.onbeforeunload = () => {
                ws.send(JSON.stringify({
                    type: "user_leave",
                    username: username
                }));
            };
        }

        async function loadHistory(me) {
            try {
                const response = await fetch(`/messages?token=${encodeURIComponent(token)}`);
                const messages = await response.json();
                messages.forEach(msg => appendMessage(msg.username, msg.content, msg.username === me));
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (content && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "message",
                    content: content
                }));
                input.value = '';
            }
        }

        function appendMessage(username, content, isSelf) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += `
                <div class="flex items-center gap-2 ${isSelf ? 'message-self' : 'message-other'}">
                    ${
                        isSelf ? 
                        `<div class="chat-bubble chat-bubble-primary">${content}</div>
                        <span class="font-bold text-primary">${username}</span>` 
                        :
                        `<span class="font-bold text-primary">${username}</span>
                        <div class="chat-bubble bg-base-300">${content}</div>`
                    }
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function appendSystemMessage(content) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += `
                <div class="flex justify-center my-2">
                    <div class="text-sm text-gray-400 italic">${content}</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>